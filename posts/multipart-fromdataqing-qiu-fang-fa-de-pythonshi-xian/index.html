<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>multipart_fromdata请求方法的python实现</title>
  <meta name=author content="cylind">
  <meta name=description content="&amp;lt;p&amp;gt;遇见这种请求方式好几次了，都是现查现用，原理啥的都不了解，用了就忘。以前觉得键值对的json&#x2F;data(application&#x2F;x-www-form-urlencoded)就够了，现在看来这玩意儿还挺重要的，应用挺广泛，有必要记录学习一下了。&amp;lt;&#x2F;p&amp;gt;&amp;lt;span id=&amp;quot;continue-reading&amp;quot;&amp;gt;&amp;lt;&#x2F;span&amp;gt;&amp;lt;p&amp;gt;multipart_fromdata将要传输的内容分为多个部分，…" />
  <meta name="robots" content="max-image-preview:large" />
  <link rel=canonical href="/posts/multipart-fromdataqing-qiu-fang-fa-de-pythonshi-xian/">
  <meta property="og:type" content="article">
  <meta property="og:url" content="/posts/multipart-fromdataqing-qiu-fang-fa-de-pythonshi-xian/">
  <meta property="og:site_name" content="cylind blog">
  <meta property="og:title" content="multipart_fromdata请求方法的python实现">
  <meta property="og:description" content="&amp;lt;p&amp;gt;遇见这种请求方式好几次了，都是现查现用，原理啥的都不了解，用了就忘。以前觉得键值对的json&#x2F;data(application&#x2F;x-www-form-urlencoded)就够了，现在看来这玩意儿还挺重要的，应用挺广泛，有必要记录学习一下了。&amp;lt;&#x2F;p&amp;gt;&amp;lt;span id=&amp;quot;continue-reading&amp;quot;&amp;gt;&amp;lt;&#x2F;span&amp;gt;&amp;lt;p&amp;gt;multipart_fromdata将要传输的内容分为多个部分，…">
  <meta name=twitter:card content="summary">
  <meta name=twitter:title content="multipart_fromdata请求方法的python实现">
  <meta name=twitter:description content="&amp;lt;p&amp;gt;遇见这种请求方式好几次了，都是现查现用，原理啥的都不了解，用了就忘。以前觉得键值对的json&#x2F;data(application&#x2F;x-www-form-urlencoded)就够了，现在看来这玩意儿还挺重要的，应用挺广泛，有必要记录学习一下了。&amp;lt;&#x2F;p&amp;gt;&amp;lt;span id=&amp;quot;continue-reading&amp;quot;&amp;gt;&amp;lt;&#x2F;span&amp;gt;&amp;lt;p&amp;gt;multipart_fromdata将要传输的内容分为多个部分，…">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <link rel="icon" sizes="16x16" href="/favicon.ico" />
  <link rel=alternate type=application/rss+xml href="/index.xml" title=cylind blog/>
  <link rel="stylesheet" href="/main.css"/>
</head>

<body>
  <header>
    <a class="header__verification" href="">cylind blog</a>
    <p class="header__official">Official</p>
    <nav>
      <ul>
        <li>
          <a href="/">Home</a>
          
        </li>
        <li>
          <a href="/posts/">Posts</a>
          
        </li>
        <li>
          <a href="/about/">About</a>
          
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
      <header>
        <h1>multipart_fromdata请求方法的python实现</h1>
        <span>
          <br><time datetime="2021-02-24T02:31:10">Feb 24, 2021</time>
        </span>
      </header><p>遇见这种请求方式好几次了，都是现查现用，原理啥的都不了解，用了就忘。以前觉得键值对的json/data(application/x-www-form-urlencoded)就够了，现在看来这玩意儿还挺重要的，应用挺广泛，有必要记录学习一下了。</p>
<span id="continue-reading"></span>
<p>multipart_fromdata将要传输的内容分为多个部分，各部分内容用一个统一的分隔符标识开始（这个分隔符可以是任意内容，只要能起唯一标识的分隔作用即可），直到遇到下一部分内容的分隔符，而最后一部分内容的分隔符需要加上<code>--</code>以示结束。各部分内容都有许多参数，有的是自动生成，有的是固定用法（规定要这么写），其中最主要的name和value，相当于传统的www-form中的键值对 <code>{name : value }</code></p>
<p>具体形式如下：</p>
<pre style="background-color:#ffffff;color:#323232;"><code><span>-----------------------------Separator-character
</span><span>Content-Disposition: form-data; name=&quot;part1&quot;
</span><span>
</span><span>value1
</span><span>-----------------------------Separator-character
</span><span>Content-Disposition: form-data; name=&quot;part2&quot;
</span><span>
</span><span>value2
</span><span>-----------------------------Separator-character
</span><span>Content-Disposition: form-data; name=&quot;the-last-part&quot;
</span><span>
</span><span>value3
</span><span>-----------------------------Separator-character--
</span></code></pre>
<p>基于实用原则，这里只给出最简单的实现方法，具体原理不细揪，multipart_fromdata的格式直接用现成的python第三方库requests_toolbelt来实现。话不多说，直接上两个例子。</p>
<h2 id="an-li-yi-zhi-hui-shu">案例一：智慧树</h2>
<p>智慧树个人头像更换时，上传图片就是用的multipart/fromdata。通过浏览器抓包，可以看到其发送的内容。</p>
<p>首先，查看其请求头部分：</p>
<p><img src="https://cdn.jsdelivr.net/gh/ghcdn/img/20210305234017.png" alt="" /></p>
<p>从上图可看出，这个请求使用multipart_fromdata编码格式来传输内容，且各部分内容间的分隔符为<code>-----------------------------15883549271175967036310302373</code></p>
<p>其次，查看请求部分的payload数据：</p>
<p><img src="https://cdn.jsdelivr.net/gh/ghcdn/img/20210305233128.png" alt="image-20210305232720034" />
<img src="https://cdn.jsdelivr.net/gh/ghcdn/img/20210305233234.png" alt="" /></p>
<p>从中可以看出，其payload的内容就只有一个，即imgFile，只包含二进制图片文件。其中，Content-Disposition、Content-Type和filename根据被打开的文件确定，name对应的imgFile则是这个参数的名称。</p>
<p>具体python实现代码如下：</p>
<pre data-lang="python" style="background-color:#ffffff;color:#323232;" class="language-python "><code class="language-python" data-lang="python"><span style="font-weight:bold;color:#a71d5d;">import </span><span>requests
</span><span style="font-weight:bold;color:#a71d5d;">from </span><span>requests_toolbelt </span><span style="font-weight:bold;color:#a71d5d;">import </span><span>MultipartEncoder
</span><span>
</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">upload</span><span>(file):
</span><span>    url </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&#39;https://base1.zhihuishu.com/able-commons/cut/imgupload&#39;
</span><span>    payload </span><span style="font-weight:bold;color:#a71d5d;">= </span><span>{</span><span style="color:#183691;">&#39;imgFile&#39;</span><span>: (file, </span><span style="color:#62a35c;">open</span><span>(file, </span><span style="color:#183691;">&#39;rb&#39;</span><span>), </span><span style="color:#183691;">&#39;image/png&#39;</span><span>)}
</span><span>    m </span><span style="font-weight:bold;color:#a71d5d;">= </span><span>MultipartEncoder(payload)
</span><span>    headers </span><span style="font-weight:bold;color:#a71d5d;">= </span><span>{</span><span style="color:#183691;">&#39;Content-Type&#39;</span><span>: m.content_type}
</span><span>    r </span><span style="font-weight:bold;color:#a71d5d;">= </span><span>requests.post(url, headers</span><span style="font-weight:bold;color:#a71d5d;">=</span><span>headers, data</span><span style="font-weight:bold;color:#a71d5d;">=</span><span>m)
</span><span>    </span><span style="color:#62a35c;">print</span><span>(r.json())
</span><span>
</span><span>
</span><span style="font-weight:bold;color:#a71d5d;">if </span><span>__name__ </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#183691;">&#39;__main__&#39;</span><span>:
</span><span>    upload(</span><span style="color:#183691;">&#39;xxx.png&#39;</span><span>)
</span></code></pre>
<h2 id="an-li-er-chao-xing-yun-pan">案例二：超星云盘</h2>
<p>超星云盘网页版上传文件也是用的multipart_fromdata编码格式。</p>
<p>同样地，先看其请求头：</p>
<p><img src="https://cdn.jsdelivr.net/gh/ghcdn/img/20210305235820.png" alt="" /></p>
<p>可以看出，其使用multipart_fromdata编码格式来传输内容，且各部分内容间的分隔符为<code>---------------------------1682890927123165149599605516</code></p>
<p>再看其请求部分的payload：</p>
<p><img src="https://cdn.jsdelivr.net/gh/ghcdn/img/20210306000414.png" alt="" /></p>
<p><img src="https://cdn.jsdelivr.net/gh/ghcdn/img/20210306000533.png" alt="" /></p>
<p>可以看出，其包含多个参数folderId，puid，id，name，type，size等等，最后一个参数是上传的二进制图片。</p>
<p>具体python实现代码如下：</p>
<pre data-lang="python" style="background-color:#ffffff;color:#323232;" class="language-python "><code class="language-python" data-lang="python"><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">upload</span><span>(filePath, name, folderId):
</span><span>    payload </span><span style="font-weight:bold;color:#a71d5d;">= </span><span>{</span><span style="color:#183691;">&#39;folderId&#39;</span><span>: folderId, </span><span style="color:#183691;">&#39;puid&#39;</span><span>: uid, </span><span style="color:#183691;">&#39;id&#39;</span><span>: </span><span style="color:#183691;">&#39;WU_FILE_2&#39;</span><span>, </span><span style="color:#183691;">&#39;name&#39;</span><span>: name, </span><span style="color:#183691;">&#39;type&#39;</span><span>: </span><span style="color:#183691;">&#39;image/png&#39;</span><span>, </span><span style="color:#183691;">&#39;lastModifiedDate&#39;</span><span>: </span><span style="color:#183691;">&#39;&#39;</span><span>, </span><span style="color:#183691;">&#39;size&#39;</span><span>: </span><span style="color:#183691;">&#39;&#39;</span><span>, </span><span style="color:#183691;">&#39;file&#39;</span><span>: (name, </span><span style="color:#62a35c;">open</span><span>(filePath, </span><span style="color:#183691;">&#39;rb&#39;</span><span>), </span><span style="color:#183691;">&#39;image/png&#39;</span><span>)}
</span><span>    cookies </span><span style="font-weight:bold;color:#a71d5d;">= </span><span>{} </span><span style="font-style:italic;color:#969896;"># 需要添加cookies认证
</span><span>    m </span><span style="font-weight:bold;color:#a71d5d;">= </span><span>MultipartEncoder(payload)
</span><span>    header </span><span style="font-weight:bold;color:#a71d5d;">= </span><span>{</span><span style="color:#183691;">&#39;Content-Type&#39;</span><span>: m.content_type}
</span><span>    p </span><span style="font-weight:bold;color:#a71d5d;">= </span><span>requests.post(</span><span style="color:#183691;">&#39;https://pan-yz.chaoxing.com/opt/upload&#39;</span><span>, data</span><span style="font-weight:bold;color:#a71d5d;">=</span><span>m,
</span><span>                      cookies</span><span style="font-weight:bold;color:#a71d5d;">=</span><span>cookies, headers</span><span style="font-weight:bold;color:#a71d5d;">=</span><span>header)
</span><span>    </span><span style="color:#62a35c;">print</span><span>(name, p.json()[</span><span style="color:#183691;">&#39;msg&#39;</span><span>])
</span><span>    </span><span style="font-weight:bold;color:#a71d5d;">return </span><span>p.json()[</span><span style="color:#183691;">&#39;msg&#39;</span><span>]
</span></code></pre>
<h2 id="can-kao">参考</h2>
<p>https://stackoverflow.com/questions/4526273/what-does-enctype-multipart-form-data-mean</p>
<p>https://stackoverflow.com/questions/8659808/how-does-http-file-upload-work</p>
<p>https://pypi.org/project/requests-toolbelt/</p>
</article>
  </main>
  <footer>
    <p>
      Powered by <a target="_blank" rel="noopener" href="https://www.getzola.org">zola 0.20.0</a>
      | Theme <a target=_blank rel=noopener href=https://github.com/inhzus/zola-futu>futu@main</a>
    </p>
  </footer>
  
</body>
</html>
